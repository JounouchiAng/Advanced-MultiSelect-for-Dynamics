(function(n,t,i){window.AdvancedMultiSelectControl=function(){function u(n){var t,i,r;if(location.search!==""){t=location.search.substr(1).split("&");for(i in t)t.hasOwnProperty(i)&&(t[i]=t[i].replace(/\+/g," ").split("="));for(r in t)if(t.hasOwnProperty(r)&&t[r][0].toLowerCase()===n.toLowerCase())return t[r][1]}return null}function e(){var f=u("data"),i,n,r,t,e;if(f==null)return null;i={};n=decodeURIComponent(f).split("&");for(r in n)n.hasOwnProperty(r)&&(t=n[r].replace(/\+/g," ").split("="),t[0]&&(e=t[0].trim().toLowerCase(),i[e]=t[1]));return i}var r=window.parent.Xrm.Page,t={FORM_TYPE_CREATE:1,FORM_TYPE_UPDATE:2,FORM_TYPE_READ_ONLY:3,FORM_TYPE_DISABLED:4,FORM_TYPE_BULK_EDIT:6},f;return n(window.document).unbind("keydown").bind("keydown",function(n){n.keyCode===8&&n.preventDefault()}),f=function(f){var o=this;o.DataLoaded=ko.observable(!1);o.ItemSet=ko.observableArray([]);o.ItemSetByRows=ko.observableArray([]);o.ColumnCount=ko.observable(parseInt(f)||1);o.SavingAttr=null;o.Items=null;o.ErrorMessage=ko.observable(null);o.ModeMessage=ko.observable(null);o.AllowUpdate=ko.observable(!1);o.ReadOnlyMode=ko.observable(!0);o.Visible=ko.observable(!0);var s=function(){for(var t=[],i=o.ItemSet(),n=0,r=i.length;n<r;n++)i[n].Value()&&t.push(i[n].Id);return t.length===0?"-":t.join(";")},c=function(){var n=s();o.SavingAttr.setSubmitMode("always");o.SavingAttr.setValue(n)},l=function(){var n=o.SavingAttr.getValue();return n==null||n===""?null:n==="-"?[]:n.split(";")},a=function(t,u,f){var e=n.Deferred(),s={EntityLogicalName:u,RecordId:t,ItemSetName:f};return i.ExecuteAction("pavelkh_GetItemSet",s).then(function(n){o.SavingAttr=r.getAttribute(n.SavingAttributeLogicalName);o.SavingAttr||e.reject(n.SavingAttributeLogicalName+" hidden dummy saving attribute is expected to be on the form but is not found on it.");o.Items=JSON.parse(n.Items);o.AllowUpdate(JSON.parse(n.AllowUpdate));e.resolve()},e.reject),e.promise()},v=function(){var t=n.Deferred(),f=u("typename"),o,r,i;return f?(o=decodeURIComponent(u("id")),r=e(),!r)?(t.reject({message:"Error! Data parameters is not provided to the checkbox set control."}),t.promise()):(i=r.itemsetname,!i)?(t.reject({message:"Error! Data parameters provided to the multiselect set control are invalid."}),t.promise()):(i=i.replace(/"/g,""),a(o,f,i).then(function(){t.resolve()},t.reject),t.promise()):(t.reject({message:"Error! Entity type is not provided to the checkbox set control."}),t.promise())},y=function(){if(!r.ui){o.Visible(!1);return}switch(r.ui.getFormType()){case t.FORM_TYPE_CREATE:case t.FORM_TYPE_UPDATE:case t.FORM_TYPE_READ_ONLY:case t.FORM_TYPE_DISABLED:o.Visible(!0);break;default:o.Visible(!1)}},h=function(){var n;if(o.AllowUpdate())switch(r.ui.getFormType()){case t.FORM_TYPE_CREATE:n=!o.SavingAttr.getUserPrivilege().canCreate;break;case t.FORM_TYPE_UPDATE:n=!o.SavingAttr.getUserPrivilege().canUpdate;break;case t.FORM_TYPE_READ_ONLY:case t.FORM_TYPE_DISABLED:n=!0;break;default:n=!0}else n=!0;o.ReadOnlyMode(n)},p=function(){try{var n=r.ui.getFormType();setTimeout(function(){var t=r.ui.getFormType();t!==n&&h()},1e3)}catch(t){}},w=function(){try{r.data.entity.addOnSave(p)}catch(n){}};o.Initialize=function(){w();var t=n.Deferred();return(y(),!o.Visible())?(o.ModeMessage("The content of this section is not available in such form mode."),o.DataLoaded(!0),t.resolve(),t.promise()):(v().then(function(){var v=l(),p=!!v,w,r,e,b,u,k,y,d,g,a,i,nt,f,tt;for(h(),w=p?n(v):null,r=[],e=0,b=o.Items.length;e<b;e++)u=o.Items[e],k=v?n.inArray(u.Id,w)>-1:u.Selected,y=ko.observable(k),y.subscribe(c),u.Value=y,r.push(u);for(o.ItemSet=ko.observableArray(r),d=p?"always":"never",o.SavingAttr.setSubmitMode(d),g=s(),o.SavingAttr.setValue(g),a=[],nt=o.ColumnCount(),f=0,tt=r.length;f<tt;f++)f%nt==0&&(i&&a.push(i),i=[]),i.push(r[f]);i&&a.push(i);o.ItemSetByRows=ko.observableArray(a);o.DataLoaded(!0);t.resolve()},function(n){var i;i=n?n.message?"Error: "+n.message:n.toString():"There is no error details.";o.DataLoaded(!0);o.ErrorMessage(i);t.reject(n)}),t.promise())}},{ViewModel:f}}()})(window.xrmjQuery,window.xrmjQuery,window.CrmWebApiFacade);