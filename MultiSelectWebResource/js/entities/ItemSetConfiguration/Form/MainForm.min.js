var AdvancedMultiSelect=window.AdvancedMultiSelect||{__namespace:!0};AdvancedMultiSelect.ItemSetConfiguration=AdvancedMultiSelect.ItemSetConfiguration||{__namespace:!0};AdvancedMultiSelect.ItemSetConfiguration.Form=function(){var e="IFRAME_QueryBuilder",k="SaveBeforeActionWarning",v=!1,y=!1,i,r,l,d,f,u,o,n={entityName:null,itemSetName:null,relationshipName:null,savingAttributeName:null,labelAttributeName:null,tooltipAttributeName:null,saveAction:null,fetchXml:null,useQueryBuilder:null,queryBuilderIframe:null,description:null,createNewSavingAttribute:null,newSavingAttributeName:null,newSavingAttributeDisplayName:null,newSavingAttributeLength:null,autoprocessItemStatus:null,autoprocessItemStatusAttributeName:null,handleSecurityPrivileges:null},t={entityName:null,itemSetName:null,relationshipName:null,savingAttributeName:null,itemSetEntityName:null,labelAttributeName:null,tooltipAttributeName:null,saveAction:null,fetchXml:null,useQueryBuilder:null,createNewSavingAttribute:null,newSavingAttributeName:null,newSavingAttributeDisplayName:null,newSavingAttributeLength:null,autoprocessItemStatus:null,autoprocessItemStatusAttributeName:null,publishRequired:null},ei=function(){i=Xrm.Page;r=AdvancedMultiSelect.FormUtils;l=AdvancedMultiSelect.AdvFindUtils;d=AdvancedMultiSelect.XmlUtils},oi=function(){n.entityName=i.getControl("pavelkh_entityname");n.itemSetName=i.getControl("pavelkh_itemsetname");n.relationshipName=i.getControl("pavelkh_relationshipname");n.savingAttributeName=i.getControl("pavelkh_dummysavingfield");n.labelAttributeName=i.getControl("pavelkh_labelattributename");n.tooltipAttributeName=i.getControl("pavelkh_tooltipattributename");n.saveAction=i.getControl("pavelkh_savechangeshandler");n.fetchXml=i.getControl("pavelkh_fetchxml");n.useQueryBuilder=i.getControl("pavelkh_usequerybuilder");n.queryBuilderIframe=i.getControl(e);n.description=i.getControl("pavelkh_description");n.createNewSavingAttribute=i.getControl("pavelkh_createnewdummysavingattribute");n.newSavingAttributeName=i.getControl("pavelkh_newdummysavingfield");n.newSavingAttributeDisplayName=i.getControl("pavelkh_newdummysavingfielddisplayname");n.newSavingAttributeLength=i.getControl("pavelkh_newdummysavingattributelength");n.autoprocessItemStatus=i.getControl("pavelkh_autoprocessitemstatus");n.autoprocessItemStatusAttributeName=i.getControl("pavelkh_autoprocessitemstatusattributename");n.handleSecurityPrivileges=i.getControl("pavelkh_handlesecurityprivileges");t.entityName=n.entityName.getAttribute();t.itemSetName=n.itemSetName.getAttribute();t.relationshipName=n.relationshipName.getAttribute();t.savingAttributeName=n.savingAttributeName.getAttribute();t.itemSetEntityName=i.getAttribute("pavelkh_itemsetentityname");t.labelAttributeName=n.labelAttributeName.getAttribute();t.tooltipAttributeName=n.tooltipAttributeName.getAttribute();t.saveAction=n.saveAction.getAttribute();t.fetchXml=n.fetchXml.getAttribute();t.useQueryBuilder=n.useQueryBuilder.getAttribute();t.createNewSavingAttribute=n.createNewSavingAttribute.getAttribute();t.newSavingAttributeName=n.newSavingAttributeName.getAttribute();t.newSavingAttributeDisplayName=n.newSavingAttributeDisplayName.getAttribute();t.newSavingAttributeLength=n.newSavingAttributeLength.getAttribute();t.autoprocessItemStatus=n.autoprocessItemStatus.getAttribute();t.autoprocessItemStatusAttributeName=n.autoprocessItemStatusAttributeName.getAttribute();t.publishRequired=i.getAttribute("pavelkh_publishrequired")},si=function(){t.useQueryBuilder.setSubmitMode("never")},hi=function(){return Xrm.Page.data.entity.getId()},s=function(n,t){if(!n)return null;n=n.trim();t=t||!1;t&&(n=n.toLowerCase());for(var i=0;i<f.length;i++)if(f[i].LogicalName===n)return f[i];return null},ci=function(n,t){var i,r;if(!n)return null;for(n=n.trim(),t=t||!1,t&&(n=n.toLowerCase()),i=0;i<u.length;i++)if(r=t?u[i].UniqueName.toLowerCase()===n:u[i].UniqueName===n,r)return u[i];return null},g=function(n,t){var i=s(n,t);return i?i.Relationships:[]},nt=function(n,t){var u=[],f=s(n,t),i,r,e;if(!f)return u;for(i=0;i<f.Attributes.length;i++)r=f.Attributes[i],e=r.IsCustomAttribute&&r.MaxLength>499,e&&u.push(r);return u},p=function(n,t){var i=s(n,t);return i?i.Attributes:[]},tt=function(n,t){var i=s(n,t);return i?i.PotentialStatusAttributes:[]},it=function(n,t,i){var u=g(n,!1),r,f;if(!u)return null;for(r=0;r<u.length;r++)if(f=u[r].Relationship.trim(),i&&(t=t.toLowerCase(),f=f.toLowerCase()),f===t)return u[r];return null},li=function(n,t,i){var u=nt(n,!1),r,f;if(!u)return null;for(r=0;r<u.length;r++)if(f=u[r].LogicalName.trim(),i&&(t=t.toLowerCase()),f===t)return u[r];return null},rt=function(n,t,i){var u=p(n,!1),r,f;if(!u)return null;for(r=0;r<u.length;r++)if(f=u[r].LogicalName.trim(),i&&(t=t.toLowerCase()),f===t)return u[r];return null},ut=function(n,t,i){var u=tt(n,!1),r,f;if(!u)return null;for(r=0;r<u.length;r++)if(f=u[r].LogicalName.trim(),i&&(t=t.toLowerCase()),f===t)return u[r];return null},ai=function(){return v},vi=function(){v=!0;r.ShowWaitingNotification("Loading metadata",ai,200,"Loading metadata, please wait")},ft=function(){v=!1},yi=function(){return y},pi=function(){y=!0;r.ShowWaitingNotification("Loading metadata",yi,200,"Publishing form changes (after Item Set Name change), please wait")},et=function(){y=!1},wi=function(n){try{return window.Mscrm.CrmUri.create(String.format("$webresource:{0}",n)).toString()}catch(t){return""}},bi=function(n){var t="An error occurred while publishing form changes.";i.ui.setFormNotification(t,"ERROR","MetadataLoadError");Xrm.Utility.alertDialog(t+"\nDetails:\n"+n.message)},ki=function(n){var t="An error occurred while getting metadata.";i.ui.setFormNotification(t,"ERROR","MetadataLoadError");Xrm.Utility.alertDialog(t+"\nDetails:\n"+n.message)},ot=function(n,t){if(n){i.ui.setFormNotification(t,"ERROR",k);return}i.ui.clearFormNotification(k)},di=function(){var n=xrmjQuery.Deferred();return CrmWebApiFacade.ExecuteAction("pavelkh_ItemSetConfigurationGetEntities").then(function(t){f=JSON.parse(t.EntityList);u=JSON.parse(t.ActionList);o=JSON.parse(t.ValidPublishPrefixList);n.resolve()},function(t){n.reject(t)}),n.promise()},st=function(){return r.ValidateAutocomplete(n.entityName,function(n){var t=s(n);return!!t&&t.LogicalName===n})},ht=function(){return r.ValidateAutocomplete(n.relationshipName,function(n){var i=it(t.entityName.getValue(),n);return!!i&&i.Relationship===n})},w=function(){return r.ValidateAutocomplete(n.savingAttributeName,function(n){var r=t.createNewSavingAttribute.getValue(),i;return r?!0:(i=li(t.entityName.getValue(),n),!!i&&i.LogicalName===n)})},gi=function(){var r="ValidateNewAttrSchemaName",u=n.newSavingAttributeName,e=t.createNewSavingAttribute.getValue(),f,i;if(!e||(f=t.newSavingAttributeName.getValue(),!f))return u.clearNotification(r),!0;for(i=0;i<o.length;i++)if(f.startsWith(o[i]))return u.clearNotification(r),!0;return u.setNotification("The name should start with one of the following prefix: "+o.join(),r),!1},a=function(){var r="FetchXml Validation",u=n.fetchXml,f=function(){u.setNotification("Please provide a valid value for Fetch Xml",r)},i;try{return(i=t.fetchXml.getValue(),!i||i.trim().length===0)?(f(),!1):(xrmjQuery.parseXML(i),u.clearNotification(r),!0)}catch(e){return f(),!1}},nr=function(){return r.ValidateAutocomplete(n.saveAction,function(n){var t=ci(n);return!!t&&t.UniqueName===n}," (Or, leave the field empty.)")},ct=function(){return r.ValidateAutocomplete(n.labelAttributeName,function(n){var i=rt(t.itemSetEntityName.getValue(),n);return!!i&&i.LogicalName===n})},tr=function(){return r.ValidateAutocomplete(n.tooltipAttributeName,function(n){var i=rt(t.itemSetEntityName.getValue(),n);return!!i&&i.LogicalName===n})},ir=function(){return r.ValidateAutocomplete(n.autoprocessItemStatusAttributeName,function(n){var i=ut(t.itemSetEntityName.getValue(),n);return!!i&&i.LogicalName===n})},rr=function(){a()},lt=function(){var s=t.createNewSavingAttribute.getValue(),n,i,r,f;if(s)try{n=o[0];i=t.itemSetName.getValue();i&&(r="_dummyfield",n+=i.replace(/[^a-zA-Z0-9]/g,"").toLowerCase(),f=45,n.length+r.length>f&&(n=n.substring(0,f-r.length)+r));t.newSavingAttributeName.setValue(n);t.newSavingAttributeLength.getValue()||t.newSavingAttributeLength.setValue(4e3);var u="[SYSTEM][MultiSelect]"+i.replace(/[^a-zA-Z0-9]/g,""),e=50;u.length>e&&(u=u.substring(0,e));t.newSavingAttributeDisplayName.setValue(u)}catch(h){}},at=function(){var i=t.createNewSavingAttribute.getValue(),r;n.savingAttributeName.setVisible(!i);t.savingAttributeName.setRequiredLevel(i?"none":"required");n.newSavingAttributeName.setVisible(i);n.newSavingAttributeDisplayName.setVisible(i);n.newSavingAttributeLength.setVisible(i);r=i?"required":"none";t.newSavingAttributeName.setRequiredLevel(r);t.newSavingAttributeDisplayName.setRequiredLevel(r);t.newSavingAttributeLength.setRequiredLevel(r);lt();w()},h=function(){var r=t.itemSetEntityName.getValue(),i,u,f;if(r||(t.useQueryBuilder.setValue(!1),n.fetchXml.setDisabled(!1)),i=t.useQueryBuilder.getValue(),n.fetchXml.setDisabled(i),!i){l.ClearSrc(e);n.queryBuilderIframe.setVisible(!1);return}n.queryBuilderIframe.setVisible(!0);u=t.fetchXml.getValue();f=function(){t.useQueryBuilder.setValue(!1);h()};l.SetSrc(e,r,u,f)},b=function(){var r=t.itemSetEntityName.getValue(),n=t.labelAttributeName.getValue();if(!r||!n)return null;var i=t.tooltipAttributeName.getValue(),u=i&&i.trim()&&i.trim()!==n;return"<fetch no-lock='true' distinct='false'>  <entity name='"+r+"'>    <attribute name='"+n+"'/>"+(!u?"":"<attribute name='"+i+"'/>")+"\t   <order attribute='"+n+"' descending='false'/>  <\/entity><\/fetch>"},vt=function(){var f=t.itemSetEntityName.getValue(),e=t.labelAttributeName.getValue(),i,r,n,o,u,s;if(!f||!e)return null;if(i=t.fetchXml.getValue(),!i||i.trim().length===0)return b();try{return(r=xrmjQuery.parseXML(i),n=r.find("entity"),n.attr("name")!==f)?b():(n.children.each(function(){var n=xrmjQuery(this);n.nodeName==="attribute"&&n.remove()}),o=xrmjQuery("<attribute>",n),o.attr("name",e),u=t.tooltipAttributeName.getValue(),u&&(s=xrmjQuery("<attribute>",n),s.attr("name",u)),AdvancedMultiSelect.XmlUtils.XmlToString(r))}catch(h){return b()}},yt=function(){var i=ct(),r,u;n.fetchXml.setDisabled(!i);n.useQueryBuilder.setDisabled(!i);r=t.useQueryBuilder.getValue();r&&(t.useQueryBuilder.setValue(!1),h());i&&(u=AdvancedMultiSelect.XmlUtils.FormatXml(vt()),t.fetchXml.setValue(u),a())},ur=function(){var i=tr(),r,u;n.fetchXml.setDisabled(!i);n.useQueryBuilder.setDisabled(!i);r=t.useQueryBuilder.getValue();r&&(t.useQueryBuilder.setValue(!1),h());i&&(u=AdvancedMultiSelect.XmlUtils.FormatXml(vt()),t.fetchXml.setValue(u),a())},fr=function(){ir()},pt=function(){ht();var n=it(t.entityName.getValue(),t.relationshipName.getValue()),i=n?n.ItemSetEntity:"";t.itemSetEntityName.setValue(i);yt()},wt=function(){w()},er=function(){gi()},or=function(n){st();pt();wt(n)},sr=function(){lt()},hr=function(){nr()},bt=function(){r.ShowAutocomplete(n.entityName,f,function(n,t){var r=f[t],u=r.LogicalName,e=r.DisplayName,i=r.Icon,o;return(i=i.indexOf("/WebResource/")===0?wi(i):i,i=!i?"/_imgs/ico_16_customEntity.gif":i,o=n.length===0||u.indexOf(n)>=0||e.indexOf(n)>=0,o)?{id:t,fields:[u,e],icon:i}:null})},kt=function(){r.ShowAutocomplete(n.saveAction,u,function(n,t){var i=u[t],r=i.UniqueName,f=i.Name,e=n.length===0||r.indexOf(n)>=0||f.indexOf(n)>=0;return e?{id:t,fields:[r,f],icon:"/_imgs/ico_16_4703.png"}:null})},dt=function(){var u=t.entityName.getValue(),i=g(u);r.ShowAutocomplete(n.relationshipName,i,function(n,t){var r=i[t],u=r.Relationship,f=r.ItemSetEntity,e=n.length===0||u.toLowerCase().indexOf(n)>=0||f.toLowerCase().indexOf(n)>=0;return e?{id:t,fields:[u,"=>"+f],icon:"/_imgs/ico_16_relationshipsN2N.gif"}:null})},gt=function(){var u=t.entityName.getValue(),i=nt(u);r.ShowAutocomplete(n.savingAttributeName,i,function(n,t){var r=i[t],u=r.LogicalName,f=r.DisplayName,o=n.length===0||u.indexOf(n)>=0||f.indexOf(n)>=0,e;return o?(e="MaxLength: "+r.MaxLength,{id:t,fields:[u,f,e],icon:"/_imgs/ico_18_attributes.gif"}):null})},ni=function(){var u=t.itemSetEntityName.getValue(),i=p(u);r.ShowAutocomplete(n.labelAttributeName,i,function(n,t){var r=i[t],u=r.LogicalName,f=r.DisplayName,s=n.length===0||u.indexOf(n)>=0||f.indexOf(n)>=0,e,o;return s?(e="MaxLength: "+r.MaxLength,o=r.IsCustomAttribute?"Custom":"Out-of-box",{id:t,fields:[u,f,e,o],icon:"/_imgs/ico_18_attributes.gif"}):null})},ti=function(){var u=t.itemSetEntityName.getValue(),i=p(u);r.ShowAutocomplete(n.tooltipAttributeName,i,function(n,t){var r=i[t],u=r.LogicalName,f=r.DisplayName,s=n.length===0||u.indexOf(n)>=0||f.indexOf(n)>=0,e,o;return s?(e="MaxLength: "+r.MaxLength,o=r.IsCustomAttribute?"Custom":"Out-of-box",{id:t,fields:[u,f,e,o],icon:"/_imgs/ico_18_attributes.gif"}):null})},ii=function(){var u=t.itemSetEntityName.getValue(),i=tt(u);r.ShowAutocomplete(n.autoprocessItemStatusAttributeName,i,function(n,t){var r=i[t],u=r.LogicalName,f=r.DisplayName,o=n.length===0||u.indexOf(n)>=0||f.indexOf(n)>=0,e;return o?(e=r.IsCustomAttribute?"Custom":"Out-of-box",{id:t,fields:[u,f,e],icon:"/_imgs/ico_18_attributes.gif"}):null})},cr=function(){var i=t.useQueryBuilder.getValue(),n;if(i)try{n=l.GetAdvFindControl(e).get_fetchXml();n.indexOf("no-lock")===-1&&(n=n.replace("<fetch",'<fetch no-lock="true" '));t.fetchXml.setValue(d.FormatXml(n));a()}catch(r){Xrm.Page.Utility.alertDialog("An error occured while updating Fetch Xml. Please specify Fetch Xml manually.")}},lr=function(){n.entityName.addOnKeyPress(bt);n.relationshipName.addOnKeyPress(dt);n.savingAttributeName.addOnKeyPress(gt);n.labelAttributeName.addOnKeyPress(ni);n.tooltipAttributeName.addOnKeyPress(ti);n.saveAction.addOnKeyPress(kt);n.autoprocessItemStatusAttributeName.addOnKeyPress(ii)},c=function(){return i.ui.getFormType()===AdvancedMultiSelect.FormTypes.FORM_TYPE_CREATE},ri=function(t){var r=c(),i=!r||t;n.entityName.setDisabled(i);n.itemSetName.setDisabled(t);n.relationshipName.setDisabled(t);n.savingAttributeName.setDisabled(i);n.labelAttributeName.setDisabled(t);n.tooltipAttributeName.setDisabled(t);n.saveAction.setDisabled(t);n.description.setDisabled(t);n.createNewSavingAttribute.setDisabled(i);n.newSavingAttributeName.setDisabled(i);n.newSavingAttributeDisplayName.setDisabled(i);n.newSavingAttributeLength.setDisabled(i);n.createNewSavingAttribute.setVisible(r);n.autoprocessItemStatus.setDisabled(t);n.autoprocessItemStatusAttributeName.setDisabled(t);n.handleSecurityPrivileges.setDisabled(t)},ar=function(){vi();var n=xrmjQuery.Deferred();return di().then(function(){ft();n.resolve()},function(t){ft();n.reject(t)}),n.promise()},vr=function(){Xrm.Page.ui.setFormNotification("Auto-save is disabled for this form.","INFO","autosaveinfo")},yr=function(){try{r.GetInputElemByControl(n.entityName).onfocus=function(){bt()};r.GetInputElemByControl(n.relationshipName).onfocus=function(){dt()};r.GetInputElemByControl(n.savingAttributeName).onfocus=function(){gt()};r.GetInputElemByControl(n.labelAttributeName).onfocus=function(){ni()};r.GetInputElemByControl(n.tooltipAttributeName).onfocus=function(){ti()};r.GetInputElemByControl(n.saveAction).onfocus=function(){kt()};r.GetInputElemByControl(n.autoprocessItemStatusAttributeName).onfocus=function(){ii()}}catch(t){}},pr=function(){var i=c(),t;i||(t=st()&&ht()&&w()&&ct(),t&&(n.useQueryBuilder.setDisabled(!1),n.fetchXml.setDisabled(!1)))},wr=function(){var r,t;try{if(r="updateFetchXmlButton",xrmjQuery("#"+r,parent.document).length!==0)return;t=xrmjQuery("<button/>",{text:"Update Fetch Xml",id:r,"class":"ms-crm-Button",click:cr});t.attr("onmouseover","window.parent.Mscrm.ButtonUtils.hoverOn(this)");t.attr("onmouseout","window.parent.Mscrm.ButtonUtils.hoverOff(this)");t.css("margin-top","5px").css("margin-bottom","5px");t.insertBefore(xrmjQuery("#"+e,parent.document))}catch(u){n.useQueryBuilder.setVisible(!1);i.ui.setFormNotification("Query Builder Edit Mode does not work in this environment. You have to specify Fetch Xml Query manually.","WARNING","createUpdateFetchXmlButtonWarning")}},br=function(){var t=c();t&&n.entityName.setFocus()},kr=function(){var n=c();t.createNewSavingAttribute.setValue(n);at()},ui=function(i){var u=!!t.autoprocessItemStatus.getValue(),f,r;n.autoprocessItemStatusAttributeName.setVisible(u);t.autoprocessItemStatusAttributeName.setRequiredLevel(u?"required":"none");i&&(f=t.itemSetEntityName.getValue(),r=ut(f,"statecode",!0),r&&t.autoprocessItemStatusAttributeName.setValue(r.LogicalName))},dr=function(){var n=xrmjQuery.Deferred(),f=c(),i,r,u;return f?n.resolve():(i=t.publishRequired.getValue(),i?(pi(),r=hi().replace("{","").replace("}",""),u="pavelkh_advancedmultiselectitemsetconfigurations("+r+")/Microsoft.Dynamics.CRM.pavelkh_PublishAfterItemSetConfigurationRenaming",CrmWebApiFacade.ExecuteAction(u).then(function(){et();n.resolve()},function(t){et();n.reject(t)})):n.resolve()),n.promise()},fi=function(n){n&&(ei(),oi(),si());ar().then(function(){n&&(vr(),lr(),yr(),br(),wr());kr();dr().then(function(){ri(!1);pr();ui();t.useQueryBuilder.setValue(!1);try{h()}catch(n){}},function(){bi()})},function(n){ki(n)})},gr=function(){fi(!0)},nu=function(n){AdvancedMultiSelect.FormUtils.PreventAutoSave(n)},tu=function(){ri(!0);fi(!1);ot(!1)},iu=function(){tu()},ru=function(){var t=i.data.entity,n,r;if(t.getIsDirty()){ot(!0,"Please save the form before you switch to the Add Control Wizard Form.");return}n={};n.formid="B5FA4DFB-E897-45CF-ABED-39A9B34A6E1A";n.parameter_validopen=!0;r=t.getId();Xrm.Utility.openEntityForm("pavelkh_advancedmultiselectitemsetconfiguration",r,n)},uu=function(){ui(!0)},fu=function(){Xrm.Page.ui.close()};return{OnFormLoad:gr,OnFormSave:nu,OnEntityNameChange:or,OnItemSetNameChange:sr,OnRelationshipNameChange:pt,OnDummySavingAttributeNameChange:wt,OnFetchXmlChange:rr,OnLabelAttributeNameChange:yt,OnTooltipAttributeNameChange:ur,OnQueryEditModeChange:h,OnSaveActionChange:hr,OnCreateNewDummyAttributeChange:at,OnNewAttributeSchemaNameChange:er,ModifiedOnChanged:iu,NavigateToAddControlWizardForm:ru,OnAutoprocessItemStatusChange:uu,OnAutoprocessItemStatusAttributeNameChange:fr,CloseForm:fu}}();